name: Update Playbook Registry

on:
  push:
    paths:
      - 'playbooks/**/meta.json'
      - 'playbooks/**/index.html'

jobs:
  update-registry:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate registry.json
        run: |
          echo "Scanning playbooks..."
          echo "[" > playbooks/registry.json
          FIRST=true
          for meta in playbooks/*/meta.json; do
            if [ -f "$meta" ]; then
              # Only include active playbooks
              STATUS=$(python3 -c "import json; print(json.load(open('$meta')).get('status',''))")
              if [ "$STATUS" = "active" ]; then
                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  echo "," >> playbooks/registry.json
                fi
                cat "$meta" >> playbooks/registry.json
                echo "" >> playbooks/registry.json
              fi
            fi
          done
          echo "]" >> playbooks/registry.json
          # Pretty-print
          python3 -c "
          import json
          with open('playbooks/registry.json') as f:
              data = json.load(f)
          data.sort(key=lambda x: x.get('title',''))
          with open('playbooks/registry.json','w') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          "
          echo "Registry generated with $(python3 -c "import json; print(len(json.load(open('playbooks/registry.json'))))" ) playbooks"
          cat playbooks/registry.json

      - name: Commit registry
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add playbooks/registry.json
          if git diff --staged --quiet; then
            echo "No changes to registry"
          else
            git commit -m "chore: update playbook registry [auto]"
            git push
          fi
